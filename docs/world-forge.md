# Campaign Forge + Character Forge

`WorldForgeVersion`: `worldforge.v1.0.0`

This system builds deterministic campaign worlds from forge input and keeps narration, runtime state, and character onboarding anchored to that world model.

## Core Flow

`title + description + forge fields + overrides` -> `buildWorldSeed` -> `buildCampaignContext`

`buildCampaignContext` contains:
- `worldSeed`
- `worldContext` (bible, biome map, factions, creatures, NPC style, loot flavor, magic rules, world state)
- `dmContext` (behavior profile + narrative/tactical directives)

All generation is deterministic per input hash and preset/toggle resolution.

## Forge Input

Defined in `/Users/dev/dev-setup/repos/saga-spark-web/services/mythic-api/src/lib/worldforge/schema.ts`.

Required:
- `title`
- `description`

Optional:
- `tonePreset`
- `humorLevel`
- `lethality`
- `magicDensity`
- `techLevel`
- `creatureFocus`
- `factionComplexity`
- `worldSize`
- `startingRegionType`
- `villainArchetype`
- `corruptionLevel`
- `divineInterferenceLevel`
- `randomizationMode`
- `manualSeedOverride`
- `playerToggles`

Presets bias values. Manual fields override.

## World Seed

`buildWorldSeed(input)` returns:
- `seedString`
- `seedNumber`
- `themeTags[]`
- `toneVector` (`darkness/whimsy/brutality/absurdity/cosmic/heroic/tragic/cozy`)
- normalized forge input and preset trace

## World Bible + Maps + Factions

Generated by:
- `generateWorldBible`
- `generateBiomeMap`
- `generateFactionGraph`
- `generateCreaturePools`
- `generateNpcStyleRules`
- `generateLootFlavorProfile`
- `generateMagicRules`
- `generateDMBehaviorProfile`

Tone vector influences biome corruption, dungeon density, creature weighting, and DM bias.

## Living World Updates

`updateWorldState(worldState, playerAction)` updates:
- world tick
- faction trust/power deltas
- villain escalation
- rumor stream
- collapsed dungeons
- historical event log

`applyWorldGrowthToContext` applies this to full campaign context and is used in runtime transitions.

## Character Forge

`forgeCharacterFromWorld({ campaignContext, input })` derives:
- origin region
- faction alignment
- background
- personality traits
- moral leaning
- starting town
- starting rumors
- starting NPC relationships
- initial faction trust

`applyCharacterForgeToState` injects these into active runtime state so the world reacts immediately.

## Integration Points

- `mythic-create-campaign`: builds campaign context from template + forge input and stores world profile payload.
- `mythic-bootstrap`: reconstructs/patches runtime with world context and DM directives.
- `mythic-join-campaign`: ensures joined players load deterministic world context.
- `mythic-runtime-transition`: converts transition reasons to world actions and advances world state.
- `mythic-dm-context`: returns `campaign_context`, `world_context`, `dm_context`, `world_seed`, and forge version.
- `mythic-dungeon-master`: consumes forge context in system prompt and returns forge meta.
- `mythic-create-character`: applies character forge, patches runtime state, and stores forge profile in character/world profile payloads.

## Determinism Tests

Deterministic tests live at:
- `/Users/dev/dev-setup/repos/saga-spark-web/services/mythic-api/src/lib/worldforge/worldforge.test.ts`

Covered assertions:
- same input -> identical world
- title changes -> divergent world identity
- one-field input change -> measurable tone vector shift
- world growth tick/history/faction updates
- character forge reproducibility per seed/context
