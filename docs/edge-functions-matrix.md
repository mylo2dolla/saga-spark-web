# Mythic Edge Function Matrix (Diffable)

Source of truth for code locations and touched tables:
- `/Users/dev/saga-spark-web/docs/edge-functions-inventory.md` (generated)

This matrix adds the **human-verified** “what it does / what it returns” layer. It is written to help you:
- detect regressions when refactoring
- keep request/response shapes stable
- understand auth + DB touch-points at a glance

Conventions
- **Auth:** `user_jwt_required` means `Authorization: Bearer <user access token>` must be present.
- **DB:** all Mythic endpoints use `SUPABASE_SERVICE_ROLE_KEY` (server-side) and therefore must do explicit authz checks.
- **Schema versioning:** responses may add fields, but must remain backward compatible.
- **Turn resolver:** `mythic-dungeon-master` is the only endpoint that is allowed to call the DM and commit a canonical turn.

## Function Matrix

| Function | Purpose | Methods | Auth | Success Response (shape) | Tables/RPCs (high signal) | LLM | Notes / Gaps |
|---|---|---|---|---|---|---|---|
| `mythic-apply-xp` | Apply XP/level server-side (deterministic) | `POST` | user_jwt_required | JSON `{ ok: true, result }` | `public.campaign_members`, `mythic.characters`, RPC `public.mythic_apply_xp` | none | Must write audit trail (see `mythic.audit_log`) once migrations applied. |
| `mythic-board-transition` | Transition boards (Town/Travel/Dungeon/Combat), persist board state + transition event | `POST` | user_jwt_required | JSON `{ ok: true, board_id, board_type, travel_goal?, search_target?, discovery_flags, warnings, requestId }` | `mythic.boards`, `mythic.board_transitions`, `mythic.world_profiles`, `mythic.factions`, `mythic.faction_reputation`, `mythic.dm_memory_events` | none | Determinism currently relies on seeded state_json; encounter selection should eventually consume turn PRNG + log rolls. |
| `mythic-bootstrap` | Ensure campaign has Mythic runtime rows (boards, world profile mirror, DM state rows) | `POST` | user_jwt_required | JSON `{ ok: true, warnings }` | `mythic.boards`, `mythic.world_profiles`, `mythic.campaign_world_profiles`, `mythic.dm_campaign_state`, `mythic.dm_world_tension` | none | Should be safe/idempotent; must not overwrite canonical seed unintentionally. |
| `mythic-combat-start` | Start a combat session and bind it to Combat board | `POST` | user_jwt_required | JSON `{ ok: true, combat_session_id, requestId }` | `mythic.combat_sessions`, `mythic.combatants`, `mythic.turn_order`, `mythic.boards`, RPC `mythic_start_combat_session`, `mythic_append_action_event` | none | Must surface `code` + `requestId` for all failures. |
| `mythic-combat-tick` | Advance combat autonomously (NPC/boss turns), resolve statuses, apply end-of-combat settlement | `POST` | user_jwt_required | JSON `{ ok: true, stepped, ended?, outcome?, requestId, warnings? }` (varies by path) | `mythic.action_events`, `mythic.combatants`, `mythic.combat_sessions`, `mythic.board_transitions`, RPC `mythic_resolve_status_tick`, `mythic_compute_damage`, `mythic_end_combat_session` | none | Deterministic selection must be seeded and replayable via action_events; ensure no direct client mutation. |
| `mythic-combat-use-skill` | Execute a player skill: range check, apply damage/heal, append action event | `POST` | user_jwt_required | JSON `{ ok: true, next_turn_index?, ended?, outcome?, requestId }` | `mythic.combatants`, `mythic.action_events`, RPC `mythic_compute_damage`, `mythic_append_action_event` | none | Content-policy validation is used for narration strings included in events. |
| `mythic-create-campaign` | Create campaign + seed Mythic runtime rows atomically with rollback on critical failures | `POST` | user_jwt_required | JSON `{ ok: true, campaign, template_key, world_seed_status, health_status, warnings, requestId }` | `public.campaigns`, `public.campaign_members`, `mythic.boards`, `mythic.world_profiles`, `mythic.factions` | none | Critical invariants: member row + active board. Rollback deletes campaign if those fail. |
| `mythic-create-character` | “Infinite class” character forge: generate class/stats/resources/skills and persist | `POST` | user_jwt_required | JSON `{ character_id, seed, class: {...}, skills: [...], skill_ids: [...], warnings, provider, model, requestId }` | `mythic.characters`, `mythic.skills`, `mythic.generator_scripts`, `mythic.game_rules` | OpenAI | **Note:** this endpoint currently does **not** include `ok: true` on success; preserve this shape for no-regression. |
| `mythic-dm-context` | Build structured DM context pack from DB truth (board/character/combat + rules/script) | `POST` | user_jwt_required | JSON `{ ok: true, context, requestId, warnings? }` | `mythic.v_*_for_dm` views, `mythic.game_rules`, `mythic.generator_scripts` | none | Should include world_state/turns once turn engine is live (read-only). |
| `mythic-dungeon-master` | **Canonical turn resolver**: call DM, validate schema + content policy, commit a turn atomically, stream response | `POST` | user_jwt_required | **SSE** OpenAI-style delta stream ending in `[DONE]` (content contains JSON object with `narration`, optional `ui_actions`, `patches`, `roll_log`, `meta`) | `mythic.v_*_for_dm` views, `mythic.turns`, RPC `public.mythic_commit_turn` | OpenAI | **Must be the only endpoint** that commits `mythic.turns`. If DM output invalid: retry once, else fallback response with **no commit**. |
| `mythic-field-generate` | Random/expand text fields (campaign/world/character prompts) | `POST` | user_jwt_required | JSON `{ ok: true, text, source, requestId }` | `mythic.world_profiles` (context) | OpenAI | Enforce content policy; return `source` = `llm` or deterministic fallback. |
| `mythic-generate-loot` | Generate deterministic loot drops and persist to inventory | `POST` | user_jwt_required | JSON `{ ok: true, character_id, count, budget_points, items }` | `mythic.items`, `mythic.inventory`, `mythic.loot_drops` | none | Must remain deterministic from `seed` + rules; should write audit record once `mythic.audit_log` is live. |
| `mythic-join-campaign` | Join campaign by invite code (idempotent) and ensure Mythic runtime rows exist | `POST` | user_jwt_required | JSON `{ ok: true, campaign, requestId, warnings? }` | `public.campaigns`, `public.campaign_members`, `mythic.boards`, `mythic.world_profiles` | none | Must reject if inactive/invalid; idempotent if already a member. |
| `mythic-list-campaigns` | List campaigns user owns or is member of, with Mythic “health” hints | `POST` | user_jwt_required | JSON `{ ok: true, campaigns, degraded?, warnings, requestId }` | `public.campaigns`, `public.campaign_members`, `mythic.world_profiles` | none | Should paginate if campaign counts grow large. |
| `mythic-recompute-character` | Recompute derived stats from equipment + progression; refresh combat snapshots | `POST` | user_jwt_required | JSON `{ ok: true, derived }` | `mythic.characters`, `mythic.inventory`, `mythic.combatants` | none | Must run after equip/unequip; should not be user-invocable for cheating. |
| `mythic-set-loadout` | Save/activate skill loadout, enforce slot rules by level | `POST` | user_jwt_required | JSON `{ ok: true, loadout, activeLoadout?, requestId }` | `mythic.character_loadouts`, `mythic.progression_events`, RPC `mythic_loadout_slots_for_level` | none | Server must enforce slot limits; client should not trust itself. |
| `mythic-shop-stock` | Get or lazily generate vendor stock (persisted in board state_json) | `POST` | user_jwt_required | JSON `{ ok: true, vendorId, vendorName, stock, requestId }` | `mythic.boards`, `mythic.characters` | none | Stock must be deterministic and persist; no client-side stock. |
| `mythic-shop-buy` | Buy item from stock: validate coins, insert item, update stock atomically | `POST` | user_jwt_required | JSON `{ ok: true, itemId, coins, vendorId, stockItemId, requestId }` | `mythic.items`, `mythic.inventory`, `mythic.boards`, `mythic.characters`, `mythic.dm_memory_events` | none | Requires `x-idempotency-key`. Must be idempotent per `(characterId, stockItemId)` to prevent double charge. |
| `mythic-tts` | Text-to-speech using OpenAI Audio Speech API | `POST` | user_jwt_required | **Audio bytes** (mp3/wav/etc) with `x-request-id` header | `public.campaigns`, `public.campaign_members` | OpenAI | Must not leak keys in logs; clamp text length and rate limit. |
| `world-content-writer` | Persist AI-generated content and/or apply a legacy world delta (append-only world_events) | `POST` | user_jwt_required | JSON `{ ok: true, inserted, requestId }` or `{ ok: true, inserted, delta, event, requestId }` (action path) | `public.ai_generated_content`, `public.world_events` | provider_resolved | **Gap:** Should eventually emit Mythic patches into `mythic.world_entities/facts` instead of legacy tables. |
| `world-generator` | Generate NPC/quest/dialog/faction/location/world payloads (utility) | `POST` | optional auth | JSON `{ ok: true, type, content, requestId }` | none | provider_resolved | Optional auth today; keep behavior unless explicitly locked down. |
