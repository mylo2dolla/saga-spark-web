services:
  mythic-api:
    build:
      context: .
    environment:
      # Required Supabase connectivity.
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_PROJECT_REF: ${SUPABASE_PROJECT_REF}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}

      # CORS allowlist (comma-separated). Leave empty to allow all origins.
      MYTHIC_ALLOWED_ORIGINS: ${MYTHIC_ALLOWED_ORIGINS:-}

      # Logging + global rate limit.
      LOG_LEVEL: ${LOG_LEVEL:-info}
      GLOBAL_RATE_LIMIT_MAX: ${GLOBAL_RATE_LIMIT_MAX:-240}
      GLOBAL_RATE_LIMIT_WINDOW_MS: ${GLOBAL_RATE_LIMIT_WINDOW_MS:-60000}

      # OpenAI is required for Mythic DM + TTS endpoints.
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-https://api.openai.com}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o-mini}
      OPENAI_TTS_MODEL: ${OPENAI_TTS_MODEL:-tts-1}

      # Deterministic turn seed salt (required for replay-safe turn engine).
      MYTHIC_TURN_SALT: ${MYTHIC_TURN_SALT:-}

      # Optional (legacy/non-Mythic) generation paths.
      LLM_PROVIDER: ${LLM_PROVIDER:-}
      LLM_MODEL: ${LLM_MODEL:-}
      GROQ_API_KEY: ${GROQ_API_KEY:-}
      GROQ_BASE_URL: ${GROQ_BASE_URL:-https://api.groq.com/openai}
      GROQ_MODEL: ${GROQ_MODEL:-llama-3.3-70b-versatile}

      # Network binding.
      HOST: 0.0.0.0
      PORT: 3001
    restart: unless-stopped

  caddy:
    image: caddy:2
    depends_on:
      - mythic-api
    ports:
      - "80:80"
      - "443:443"
    environment:
      # Use `http://:80` for IP-only HTTP cutover (no TLS, no redirects),
      # or a real domain for automatic TLS.
      MYTHIC_API_SITE: ${MYTHIC_API_SITE:-http://:80}
      CADDY_EMAIL: ${CADDY_EMAIL:-}
    volumes:
      - ./deploy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    restart: unless-stopped

volumes:
  caddy_data:
  caddy_config:

